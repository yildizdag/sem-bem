function [N, dN] = shapefunc2D(xi,eta,p)
if p == 1
    N = zeros(size(xi,1),4);
    N(:,1) = 0.25.*(1-xi).*(1-eta);
    N(:,2) = 0.25.*(1+xi).*(1-eta);
    N(:,3) = 0.25.*(1+xi).*(1+eta);
    N(:,4) = 0.25.*(1-xi).*(1+eta);
    dN = zeros(2,4,size(xi,1));
    dN(1,1,:) = -0.25.*(1-eta);
    dN(1,2,:) =  0.25.*(1-eta);
    dN(1,3,:) =  0.25.*(1+eta);
    dN(1,4,:) = -0.25.*(1+eta);
    dN(2,1,:) = -0.25.*(1-xi);
    dN(2,2,:) = -0.25.*(1+xi);
    dN(2,3,:) =  0.25.*(1+xi);
    dN(2,4,:) =  0.25.*(1-xi);
elseif p == 2
    N = zeros(size(xi,1),9);
    N(:,1) = 0.25.*xi.*eta.*(1-xi).*(1-eta);
    N(:,3) = -0.25.*xi.*eta.*(1+xi).*(1-eta);
    N(:,9) = 0.25.*xi.*eta.*(1+xi).*(1+eta);
    N(:,7) = -0.25.*xi.*eta.*(1-xi).*(1+eta);
    N(:,2) = -0.5.*eta.*(1-xi.^2).*(1-eta);
    N(:,6) = 0.5.*xi.*(1-eta.^2).*(1+xi);
    N(:,8) = 0.5.*eta.*(1-xi.^2).*(1+eta);
    N(:,4) = -0.5.*xi.*(1-eta.^2).*(1-xi);
    N(:,5) = (1-xi.^2).*(1-eta.^2);
    dN = zeros(2,9,size(xi,1));
    dN(1,1,:) =  0.25.*eta.*(1-eta).*(1-2.*xi);
    dN(1,3,:) = -0.25.*eta.*(1-eta).*(1+2.*xi);
    dN(1,9,:) =  0.25.*eta.*(1+eta).*(1+2.*xi);
    dN(1,7,:) = -0.25.*eta.*(1+eta).*(1-2.*xi);
    dN(1,2,:) =  -0.5.*eta.*(1-eta).*(-2.*xi);
    dN(1,6,:) =  0.5.*(1-eta.^2).*(1+2.*xi);
    dN(1,8,:) =  0.5.*eta.*(1+eta).*(-2.*xi);
    dN(1,4,:) =  -0.5.*(1-eta.^2).*(1-2.*xi);
    dN(1,5,:) =  (1-eta.^2).*(-2.*xi);
    dN(2,1,:) =  0.25.*xi.*(1-xi).*(1-2.*eta);
    dN(2,3,:) = -0.25.*xi.*(1+xi).*(1-2.*eta);
    dN(2,9,:) =  0.25.*xi.*(1+xi).*(1+2.*eta);
    dN(2,7,:) = -0.25.*xi.*(1-xi).*(1+2.*eta);
    dN(2,2,:) =  -0.5.*(1-xi.^2).*(1-2.*eta);
    dN(2,6,:) =  0.5.*xi.*(1+xi).*(-2.*eta);
    dN(2,8,:) =  0.5.*(1-xi.^2).*(1+2.*eta);
    dN(2,4,:) =  -0.5.*xi.*(1-xi).*(-2.*eta);
    dN(2,5,:) =  (1-xi.^2).*(-2.*eta);
elseif p == 4
    N = zeros(size(xi,1), 25);
    dN = zeros(2, 25, size(xi,1));

    % Shape functions and derivatives (generated automatically)
    N(:,1) = 0.444444444444444.*eta.*xi.*(eta - 1).*(eta - 0.5).*(eta + 0.5).*(xi - 1).*(xi - 0.5).*(xi + 0.5);
    dN(1,1,:) = 0.666666666666667.*eta.*(eta - 1).*(eta - 0.5).*(eta + 0.5).*(2.66666666666667.*xi.^3 - 2.0.*xi.^2 - 0.333333333333333.*xi + 0.166666666666667);
    dN(2,1,:) = 0.666666666666667.*xi.*(xi - 1).*(xi - 0.5).*(xi + 0.5).*(2.66666666666667.*eta.^3 - 2.0.*eta.^2 - 0.333333333333333.*eta + 0.166666666666667);

    N(:,2) = -1.77777777777778.*eta.*xi.*(eta - 1).*(eta - 0.5).*(eta + 0.5).*(xi - 1).*(xi - 0.5).*(xi + 1);
    dN(1,2,:) = -0.666666666666667.*eta.*(eta - 1).*(eta - 0.5).*(eta + 0.5).*(10.6666666666667.*xi.^3 - 4.0.*xi.^2 - 5.33333333333333.*xi + 1.33333333333333);
    dN(2,2,:) = -2.66666666666667.*xi.*(xi - 1).*(xi - 0.5).*(xi + 1).*(2.66666666666667.*eta.^3 - 2.0.*eta.^2 - 0.333333333333333.*eta + 0.166666666666667);

    N(:,3) = 0.666666666666667.*eta.*(eta - 1).*(eta - 0.5).*(eta + 0.5).*(4.0.*xi.^4 - 5.0.*xi.^2 + 1.0);
    dN(1,3,:) = 0.666666666666667.*eta.*xi.*(eta - 1).*(eta - 0.5).*(eta + 0.5).*(16.0.*xi.^2 - 10.0);
    dN(2,3,:) = (4.0.*xi.^4 - 5.0.*xi.^2 + 1.0).*(2.66666666666667.*eta.^3 - 2.0.*eta.^2 - 0.333333333333333.*eta + 0.166666666666667);

    N(:,4) = -1.77777777777778.*eta.*xi.*(eta - 1).*(eta - 0.5).*(eta + 0.5).*(xi - 1).*(xi + 0.5).*(xi + 1);
    dN(1,4,:) = -0.666666666666667.*eta.*(eta - 1).*(eta - 0.5).*(eta + 0.5).*(10.6666666666667.*xi.^3 + 4.0.*xi.^2 - 5.33333333333333.*xi - 1.33333333333333);
    dN(2,4,:) = -2.66666666666667.*xi.*(xi - 1).*(xi + 0.5).*(xi + 1).*(2.66666666666667.*eta.^3 - 2.0.*eta.^2 - 0.333333333333333.*eta + 0.166666666666667);

    N(:,5) = 0.444444444444444.*eta.*xi.*(eta - 1).*(eta - 0.5).*(eta + 0.5).*(xi - 0.5).*(xi + 0.5).*(xi + 1);
    dN(1,5,:) = 0.666666666666667.*eta.*(eta - 1).*(eta - 0.5).*(eta + 0.5).*(2.66666666666667.*xi.^3 + 2.0.*xi.^2 - 0.333333333333333.*xi - 0.166666666666667);
    dN(2,5,:) = 0.666666666666667.*xi.*(xi - 0.5).*(xi + 0.5).*(xi + 1).*(2.66666666666667.*eta.^3 - 2.0.*eta.^2 - 0.333333333333333.*eta + 0.166666666666667);

    N(:,6) = -1.77777777777778.*eta.*xi.*(eta - 1).*(eta - 0.5).*(eta + 1).*(xi - 1).*(xi - 0.5).*(xi + 0.5);
    dN(1,6,:) = -2.66666666666667.*eta.*(eta - 1).*(eta - 0.5).*(eta + 1).*(2.66666666666667.*xi.^3 - 2.0.*xi.^2 - 0.333333333333333.*xi + 0.166666666666667);
    dN(2,6,:) = -0.666666666666667.*xi.*(xi - 1).*(xi - 0.5).*(xi + 0.5).*(10.6666666666667.*eta.^3 - 4.0.*eta.^2 - 5.33333333333333.*eta + 1.33333333333333);

    N(:,7) = 7.11111111111111.*eta.*xi.*(eta - 1).*(eta - 0.5).*(eta + 1).*(xi - 1).*(xi - 0.5).*(xi + 1);
    dN(1,7,:) = 2.66666666666667.*eta.*(eta - 1).*(eta - 0.5).*(eta + 1).*(10.6666666666667.*xi.^3 - 4.0.*xi.^2 - 5.33333333333333.*xi + 1.33333333333333);
    dN(2,7,:) = 2.66666666666667.*xi.*(xi - 1).*(xi - 0.5).*(xi + 1).*(10.6666666666667.*eta.^3 - 4.0.*eta.^2 - 5.33333333333333.*eta + 1.33333333333333);

    N(:,8) = -2.66666666666667.*eta.*(eta - 1).*(eta - 0.5).*(eta + 1).*(4.0.*xi.^4 - 5.0.*xi.^2 + 1.0);
    dN(1,8,:) = -2.66666666666667.*eta.*xi.*(eta - 1).*(eta - 0.5).*(eta + 1).*(16.0.*xi.^2 - 10.0);
    dN(2,8,:) = -(4.0.*xi.^4 - 5.0.*xi.^2 + 1.0).*(10.6666666666667.*eta.^3 - 4.0.*eta.^2 - 5.33333333333333.*eta + 1.33333333333333);

    N(:,9) = 7.11111111111111.*eta.*xi.*(eta - 1).*(eta - 0.5).*(eta + 1).*(xi - 1).*(xi + 0.5).*(xi + 1);
    dN(1,9,:) = 2.66666666666667.*eta.*(eta - 1).*(eta - 0.5).*(eta + 1).*(10.6666666666667.*xi.^3 + 4.0.*xi.^2 - 5.33333333333333.*xi - 1.33333333333333);
    dN(2,9,:) = 2.66666666666667.*xi.*(xi - 1).*(xi + 0.5).*(xi + 1).*(10.6666666666667.*eta.^3 - 4.0.*eta.^2 - 5.33333333333333.*eta + 1.33333333333333);

    N(:,10) = -1.77777777777778.*eta.*xi.*(eta - 1).*(eta - 0.5).*(eta + 1).*(xi - 0.5).*(xi + 0.5).*(xi + 1);
    dN(1,10,:) = -2.66666666666667.*eta.*(eta - 1).*(eta - 0.5).*(eta + 1).*(2.66666666666667.*xi.^3 + 2.0.*xi.^2 - 0.333333333333333.*xi - 0.166666666666667);
    dN(2,10,:) = -0.666666666666667.*xi.*(xi - 0.5).*(xi + 0.5).*(xi + 1).*(10.6666666666667.*eta.^3 - 4.0.*eta.^2 - 5.33333333333333.*eta + 1.33333333333333);

    N(:,11) = 0.666666666666667.*xi.*(xi - 1).*(xi - 0.5).*(xi + 0.5).*(4.0.*eta.^4 - 5.0.*eta.^2 + 1.0);
    dN(1,11,:) = (4.0.*eta.^4 - 5.0.*eta.^2 + 1.0).*(2.66666666666667.*xi.^3 - 2.0.*xi.^2 - 0.333333333333333.*xi + 0.166666666666667);
    dN(2,11,:) = 0.666666666666667.*eta.*xi.*(16.0.*eta.^2 - 10.0).*(xi - 1).*(xi - 0.5).*(xi + 0.5);

    N(:,12) = -2.66666666666667.*xi.*(xi - 1).*(xi - 0.5).*(xi + 1).*(4.0.*eta.^4 - 5.0.*eta.^2 + 1.0);
    dN(1,12,:) = -(4.0.*eta.^4 - 5.0.*eta.^2 + 1.0).*(10.6666666666667.*xi.^3 - 4.0.*xi.^2 - 5.33333333333333.*xi + 1.33333333333333);
    dN(2,12,:) = -2.66666666666667.*eta.*xi.*(16.0.*eta.^2 - 10.0).*(xi - 1).*(xi - 0.5).*(xi + 1);

    N(:,13) = (4.0.*eta.^4 - 5.0.*eta.^2 + 1.0).*(4.0.*xi.^4 - 5.0.*xi.^2 + 1.0);
    dN(1,13,:) = xi.*(16.0.*xi.^2 - 10.0).*(4.0.*eta.^4 - 5.0.*eta.^2 + 1.0);
    dN(2,13,:) = eta.*(16.0.*eta.^2 - 10.0).*(4.0.*xi.^4 - 5.0.*xi.^2 + 1.0);

    N(:,14) = -2.66666666666667.*xi.*(xi - 1).*(xi + 0.5).*(xi + 1).*(4.0.*eta.^4 - 5.0.*eta.^2 + 1.0);
    dN(1,14,:) = -(4.0.*eta.^4 - 5.0.*eta.^2 + 1.0).*(10.6666666666667.*xi.^3 + 4.0.*xi.^2 - 5.33333333333333.*xi - 1.33333333333333);
    dN(2,14,:) = -2.66666666666667.*eta.*xi.*(16.0.*eta.^2 - 10.0).*(xi - 1).*(xi + 0.5).*(xi + 1);

    N(:,15) = 0.666666666666667.*xi.*(xi - 0.5).*(xi + 0.5).*(xi + 1).*(4.0.*eta.^4 - 5.0.*eta.^2 + 1.0);
    dN(1,15,:) = (4.0.*eta.^4 - 5.0.*eta.^2 + 1.0).*(2.66666666666667.*xi.^3 + 2.0.*xi.^2 - 0.333333333333333.*xi - 0.166666666666667);
    dN(2,15,:) = 0.666666666666667.*eta.*xi.*(16.0.*eta.^2 - 10.0).*(xi - 0.5).*(xi + 0.5).*(xi + 1);

    N(:,16) = -1.77777777777778.*eta.*xi.*(eta - 1).*(eta + 0.5).*(eta + 1).*(xi - 1).*(xi - 0.5).*(xi + 0.5);
    dN(1,16,:) = -2.66666666666667.*eta.*(eta - 1).*(eta + 0.5).*(eta + 1).*(2.66666666666667.*xi.^3 - 2.0.*xi.^2 - 0.333333333333333.*xi + 0.166666666666667);
    dN(2,16,:) = -0.666666666666667.*xi.*(xi - 1).*(xi - 0.5).*(xi + 0.5).*(10.6666666666667.*eta.^3 + 4.0.*eta.^2 - 5.33333333333333.*eta - 1.33333333333333);

    N(:,17) = 7.11111111111111.*eta.*xi.*(eta - 1).*(eta + 0.5).*(eta + 1).*(xi - 1).*(xi - 0.5).*(xi + 1);
    dN(1,17,:) = 2.66666666666667.*eta.*(eta - 1).*(eta + 0.5).*(eta + 1).*(10.6666666666667.*xi.^3 - 4.0.*xi.^2 - 5.33333333333333.*xi + 1.33333333333333);
    dN(2,17,:) = 2.66666666666667.*xi.*(xi - 1).*(xi - 0.5).*(xi + 1).*(10.6666666666667.*eta.^3 + 4.0.*eta.^2 - 5.33333333333333.*eta - 1.33333333333333);

    N(:,18) = -2.66666666666667.*eta.*(eta - 1).*(eta + 0.5).*(eta + 1).*(4.0.*xi.^4 - 5.0.*xi.^2 + 1.0);
    dN(1,18,:) = -2.66666666666667.*eta.*xi.*(eta - 1).*(eta + 0.5).*(eta + 1).*(16.0.*xi.^2 - 10.0);
    dN(2,18,:) = -(4.0.*xi.^4 - 5.0.*xi.^2 + 1.0).*(10.6666666666667.*eta.^3 + 4.0.*eta.^2 - 5.33333333333333.*eta - 1.33333333333333);

    N(:,19) = 7.11111111111111.*eta.*xi.*(eta - 1).*(eta + 0.5).*(eta + 1).*(xi - 1).*(xi + 0.5).*(xi + 1);
    dN(1,19,:) = 2.66666666666667.*eta.*(eta - 1).*(eta + 0.5).*(eta + 1).*(10.6666666666667.*xi.^3 + 4.0.*xi.^2 - 5.33333333333333.*xi - 1.33333333333333);
    dN(2,19,:) = 2.66666666666667.*xi.*(xi - 1).*(xi + 0.5).*(xi + 1).*(10.6666666666667.*eta.^3 + 4.0.*eta.^2 - 5.33333333333333.*eta - 1.33333333333333);

    N(:,20) = -1.77777777777778.*eta.*xi.*(eta - 1).*(eta + 0.5).*(eta + 1).*(xi - 0.5).*(xi + 0.5).*(xi + 1);
    dN(1,20,:) = -2.66666666666667.*eta.*(eta - 1).*(eta + 0.5).*(eta + 1).*(2.66666666666667.*xi.^3 + 2.0.*xi.^2 - 0.333333333333333.*xi - 0.166666666666667);
    dN(2,20,:) = -0.666666666666667.*xi.*(xi - 0.5).*(xi + 0.5).*(xi + 1).*(10.6666666666667.*eta.^3 + 4.0.*eta.^2 - 5.33333333333333.*eta - 1.33333333333333);

    N(:,21) = 0.444444444444444.*eta.*xi.*(eta - 0.5).*(eta + 0.5).*(eta + 1).*(xi - 1).*(xi - 0.5).*(xi + 0.5);
    dN(1,21,:) = 0.666666666666667.*eta.*(eta - 0.5).*(eta + 0.5).*(eta + 1).*(2.66666666666667.*xi.^3 - 2.0.*xi.^2 - 0.333333333333333.*xi + 0.166666666666667);
    dN(2,21,:) = 0.666666666666667.*xi.*(xi - 1).*(xi - 0.5).*(xi + 0.5).*(2.66666666666667.*eta.^3 + 2.0.*eta.^2 - 0.333333333333333.*eta - 0.166666666666667);

    N(:,22) = -1.77777777777778.*eta.*xi.*(eta - 0.5).*(eta + 0.5).*(eta + 1).*(xi - 1).*(xi - 0.5).*(xi + 1);
    dN(1,22,:) = -0.666666666666667.*eta.*(eta - 0.5).*(eta + 0.5).*(eta + 1).*(10.6666666666667.*xi.^3 - 4.0.*xi.^2 - 5.33333333333333.*xi + 1.33333333333333);
    dN(2,22,:) = -2.66666666666667.*xi.*(xi - 1).*(xi - 0.5).*(xi + 1).*(2.66666666666667.*eta.^3 + 2.0.*eta.^2 - 0.333333333333333.*eta - 0.166666666666667);

    N(:,23) = 0.666666666666667.*eta.*(eta - 0.5).*(eta + 0.5).*(eta + 1).*(4.0.*xi.^4 - 5.0.*xi.^2 + 1.0);
    dN(1,23,:) = 0.666666666666667.*eta.*xi.*(eta - 0.5).*(eta + 0.5).*(eta + 1).*(16.0.*xi.^2 - 10.0);
    dN(2,23,:) = (4.0.*xi.^4 - 5.0.*xi.^2 + 1.0).*(2.66666666666667.*eta.^3 + 2.0.*eta.^2 - 0.333333333333333.*eta - 0.166666666666667);

    N(:,24) = -1.77777777777778.*eta.*xi.*(eta - 0.5).*(eta + 0.5).*(eta + 1).*(xi - 1).*(xi + 0.5).*(xi + 1);
    dN(1,24,:) = -0.666666666666667.*eta.*(eta - 0.5).*(eta + 0.5).*(eta + 1).*(10.6666666666667.*xi.^3 + 4.0.*xi.^2 - 5.33333333333333.*xi - 1.33333333333333);
    dN(2,24,:) = -2.66666666666667.*xi.*(xi - 1).*(xi + 0.5).*(xi + 1).*(2.66666666666667.*eta.^3 + 2.0.*eta.^2 - 0.333333333333333.*eta - 0.166666666666667);

    N(:,25) = 0.444444444444444.*eta.*xi.*(eta - 0.5).*(eta + 0.5).*(eta + 1).*(xi - 0.5).*(xi + 0.5).*(xi + 1);
    dN(1,25,:) = 0.666666666666667.*eta.*(eta - 0.5).*(eta + 0.5).*(eta + 1).*(2.66666666666667.*xi.^3 + 2.0.*xi.^2 - 0.333333333333333.*xi - 0.166666666666667);
    dN(2,25,:) = 0.666666666666667.*xi.*(xi - 0.5).*(xi + 0.5).*(xi + 1).*(2.66666666666667.*eta.^3 + 2.0.*eta.^2 - 0.333333333333333.*eta - 0.166666666666667);
else
    disp('pBEM is 1, 2, or 4');
end

